{% extends 'base.html' %}
{% load static %}

{% load crispy_forms_tags %}
{% load auth_extras %}
{% load verbose_names %}

{% block page_content %}


{% block title %}
<h1 class="h3 mb-0 text-gray-800"> Επισκόπηση Αναφοράς </h1>
<a href="{% url "reports_all" %}" class="btn btn-default btn-bg">
  <span class="icon text-lightgray-5">
  <i class="fas fa-chevron-left"></i> Πίνακας Αναφορών </span>  
</a>

{% endblock title %}

{% block content %}
 

<!-- Content Row -->
<div class="row">


  <!-- New Breakdown Form -->
  <div class="col-xl-8 col-lg-7">
    <div class="card shadow mb-4"> 
      <div class="card-header py-2 d-flex align-items-center">
        {% if user.is_simple_user or user.is_ddb %}
          {% if report.status == "NE" %}
          <h6 class="mr-auto p-2 m-0 font-weight-bold text-primary"> Στοιχεία Αναφοράς {{report.number}} - ΕΚΚΡΕΜΗΣ</h6>
          {% else %}
          <h6 class="mr-auto p-2 m-0 font-weight-bold text-primary"> Στοιχεία Αναφοράς {{report.number}} - {{report.get_status_display}}</h6>          
          {% endif %}
        {% else %}
          <h6 class="mr-auto p-2 m-0 font-weight-bold text-primary"> Στοιχεία Αναφοράς {{report.number}} - {{report.get_status_display}}</h6>          
        {% endif %}
        {% if report|can_edit:user %}
        <a href="{{ request.get_full_path }}edit" class="btn btn-default p-2 mr-1">
          <span class="icon text-lightgray-50">
            <i class="fas fa-edit"></i>
          </span>
          <span class="text"> Επεξεργασία </span>
        </a>
        {% endif %}
        {% if report|can_delete:user %}
        <button id="delete_report" type="button" class="btn btn-default p-2 " data-toggle="modal" data-target="#deleteModal">
            <span class="icon text-lightgray-50">
              <i class="fas fa-trash"></i>
            </span>
            <span class="text"> Διαγραφή </span>
        </button>
        {% endif %}
      </div>
      <div class="card-body border-left-primary uppercase-input py-2">
        <table class="table">
          <tbody>
            <tr>
              <th class="border-top-0"> {% get_verbose_field_name report "means" %}</th>
              <td class="border-top-0">{% if report.means %}<span id="means">{{report.means}}</span>{% endif %}</td>
            </tr>
            <tr>
              <th scope="row"> Επηρεαζόμενος Κόμβος </th>
              <td>{{report.unit}}</td>
            </tr>
            <tr>
              <th scope="row"> Περιγραφή </th>
              <td>{{report.description}}</td>
            </tr>
            {% if report.submitter_name %}
            <tr>
              <th scope="row"> Καταχωρητής </th>
              <td>{{report.get_submitter_rank_display }} {{report.submitter_name}}</td>
            </tr>
            {% endif %}
            {% if report.attached_file %}
            <tr>
              <th scope="row"> Επισυναπτόμενo Αρχείo </th>
              <td>
                <a target="_blank" rel="noopener noreferrer" href="/user_files/{{report.attached_file}}">{{report.attached_file}}</a>
              </td>
            </tr>
            {% endif %}
            {% if report.secondary_phone %}
            <tr>
              <th>Τηλέφωνα Επικοινωνίας</th>
              <td>{{report.primary_phone}}  -  {{report.secondary_phone}}</td>
            </tr>
            {% else %}
            <tr>
              <th>Τηλέφωνο Επικοινωνίας</th>
              <td>{{report.primary_phone}}</td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>


  <div class="col-xl-4 col-lg-5">
    <div class="card shadow mb-4">
      {% if report.status != 'CL' %}
        {% if user.is_admin or user.is_manager %}
          <div class="card-header py-2 d-flex align-items-center flex-row-reverse">
            {% if report.assigned_dispatcher %}
              <button type="button" class="btn btn-default p-2 " id="select_dispatcher" data-toggle="modal" data-target="#assignModal">
                  <span class="icon text-lightgray-50">
                    <i class="fas fa-user-edit"></i>
                  </span>
                  <span class="text"> Αλλαγή </span>
              </button>
              <form method='POST' action="{% url 'report_single' report.id %}dispatcher" enctype="multipart/form-data">
                {% csrf_token %}
                <button type="submit" class="btn btn-default p-2 " id="remove_dispatcher">
                    <span class="icon text-lightgray-50">
                      <i class="fas fa-user-minus"></i>
                    </span>
                    <span class="text"> Αφαίρεση </span>
                </button>
              </form>
            {% else %}
              <button type="button" class="btn btn-default p-2 " id="select_dispatcher" data-toggle="modal" data-target="#assignModal">
                  <span class="icon text-lightgray-50">
                    <i class="fas fa-user-plus"></i>
                  </span>
                  <span class="text"> Ανάθεση </span>
              </button>
            {% endif %}
          </div>
        {% endif %}
      {% endif %}
      <div class="card-body uppercase-input py-2" style="border-right: 0.25rem solid var(--greenblue) !important;">
        <table class="table">
          <tbody>
            <tr>
              <th class="border-top-0">{% get_verbose_field_name report "date_start" %}</th>
              <td class="border-top-0">{{report.date_start}}</td>
            </tr>                    
            {% if report.status == 'CL' %}
            <tr>
              <th>{% get_verbose_field_name report "date_end" %}</th>
              <td>{{report.date_end}}</td>
            </tr>
            {% else %}
            <tr>
              <th>{% get_verbose_field_name report "date_last_modified" %}</th>
              <td>{{report.date_last_modified}}</td>
            </tr>
            {% endif %}
            <tr>
              <th>{% get_verbose_field_name report "assigned_dispatcher" %}</th>
              {% if report.assigned_dispatcher %}
              <td>{{report.assigned_dispatcher}}</td>
              {% else %}
                <td><sub>---</sub></td>   
              {% endif %}
            </tr>
          </tbody>
        </table>
      </div>  
    </div>  
  </div>

</div>

{% if report|can_complete:user  or report.status == "CL" and report.solution != "" %}
<div class="row">
  <div class="col-xl-8 col-lg-7">
    <div class="card shadow mb-4">
      <div class="card-header py-2 d-flex align-items-center">
        <h6 class="mr-auto p-2 m-0 font-weight-bold text-primary">Ενέργειες Διαικεραιωτή</h6>
      </div>
      <div class="card-body border-left-primary uppercase-input">
          <form method='POST' action="{% url 'report_single' report.id %}complete" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="form-group uppercase-input">
            <textarea {% if report.status == "CL" %}readonly{% endif %} style="resize: none;" id="report_solution" class="form-control form-control-section" name="report_solution" cols="40" rows="4"
              placeholder="Π.Χ. Η ΑΝΑΦΟΡΑ ΔΙΕΚΠΕΡΑΙΩΘΗΚΕ ΜΕ ΤΗ ΣΥΓΚΕΚΡΙΜΕΝΗ ΕΝΕΡΓΕΙΑ">{{report.solution}}</textarea>
          </div>
          {% if report|can_complete:user and report.status != "CL" %}
          <button class="btn btn-primary btn-user btn-block" id='complete_report_button' type='submit'> Ολοκλήρωση </button>
          {% endif %}
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- delete modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Διαγραφή Αναφοράς</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Είστε σίγουρος ότι θέλετε να διαγράψετε την αναφορά No.{{report.number}};</p>
        <p>Η διαγραφή αναφοράς είναι μια ενέργεια που δεν μπορεί να αναιρεθεί.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Ακύρωση</button>
        <form method='POST' action="{{ request.get_full_path }}delete" enctype="multipart/form-data">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">Ολοκλήρωση Διαγραφής</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- assign modal -->
<div class="modal fade" id="assignModal" tabindex="-1" role="dialog" aria-labelledby="assignModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Ανάθεση Αναφοράς</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Επιλογή αρμόδιου διαικεραιωτή για την αναφορά No.{{report.number}}:</p>
        <form method='POST' action="{% url 'report_single' report.id %}dispatcher" enctype="multipart/form-data">
          {% csrf_token %}
          <p id="searching_message">Αναζήτηση διαικεραιωτών...</p>
          <div id="show_dispatcher_form_select">
          <select required style="width: 100%;" data-width="100%" id="id_dispatcher_form_select" name="dispatcher_form_select" class="form-select" aria-label="dispatcherSelectionDropdown">
            <option value="" hidden disabled selected value style="color: #999 !important;">Nothing selected</option>
          </select>
          </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Ακύρωση</button>
        <button type="submit" class="btn btn-primary">Ολοκλήρωση Ανάθεσης</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- complete without solution modal -->
<div class="modal fade" id="completeModal" tabindex="-1" role="dialog" aria-labelledby="completeModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Ολοκλήρωση Αναφοράς</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Είστε σίγουρος ότι θέλετε να ολοκληρώσετε την αναφορά No.{{report.number}} χωρίς οδηγίες προς αποκατάσταση;</p>
        <small class="text-muted">(Η επιλογή σας δεν είναι δεσμευτική)</small>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Ακύρωση</button>
          <form method='POST' action="{% url 'report_single' report.id %}complete" enctype="multipart/form-data">
            {% csrf_token %}
            <button type="submit" class="btn btn-default">Ολοκλήρωση</button>
          </form>
        <button type="submit" class="btn btn-primary" data-dismiss="modal" onclick="focus_on_solution()">Προσθήκη Οδηγιών</button>
        </form>
      </div>
    </div>
  </div>
</div>

  {% endblock %}


  {% endblock %}
